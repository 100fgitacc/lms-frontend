name: Deploy LMS Frontend
on: { push: { branches: [ main ] }, workflow_dispatch: {} }
concurrency: { group: deploy-lms-frontend, cancel-in-progress: true }

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || '22' }}

    steps:
      - uses: actions/checkout@v4
      - run: echo "${{ secrets.SSH_KEY }}" > key.pem && chmod 600 key.pem
      - run: |
          ssh -i key.pem -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" "mkdir -p /var/www/lms-frontend /var/www/lms-frontend/build"
      - name: Upload sources (no src/)
        run: |
          rsync -az --delete \
            --exclude '.git' --exclude '.github' --exclude 'node_modules' \
            --exclude '.env' \
            -e "ssh -i key.pem -p $SSH_PORT -o StrictHostKeyChecking=no" \
            ./ "$SSH_USER@$SSH_HOST:/var/www/lms-frontend/"
      - name: Build & publish to /build
        run: |
          ssh -i key.pem -p "$SSH_PORT" -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" '
            set -e
            cd /var/www/lms-frontend
            npm ci
            npm run build
            rsync -az --delete build/ /var/www/lms-frontend/build/
          '
